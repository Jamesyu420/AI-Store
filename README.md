这是一个计算机应用比赛的作品。

# E经营——智能营业辅助系统

## 作品简介
商家在经营过程中，需要更好地了解顾客的购物需求、提升顾客的购物体验，进而获得更大的利益，因此就需要掌握顾客的全方位数据进行分析，制定更加精准的营销策略。而市场上为商家提供的服务纷繁复杂，更没有全方面匹配商家需求的软件。
本作品能够获取顾客多维度的信息并通过追踪与质心算法、识别算法、推荐算法与数据库相结合，设置客流监测、熟客识别、商品推荐等功能版块，最终实现帮助商店运营、为顾客制定个性化购物推荐方案的效果。
通过国产华为云一站式AI开发平台实现开发、并搭配其HiLens硬件设备的高时效性软硬件结合的人工智能产品，是本软件的特色。

## 使用说明

## 设计思路

当今时代，各式店铺越来越多，顾客的购买选择不断增加，对于购买体验感的追求也越来越高，因此，为用户提供更好的服务成为当今商家考虑的一大问题。此外，随着经济的发展，员工雇佣成本不断提高，提高工作效率与减少劳动力的不必要开支也成为商家面临的重要问题。为帮助商家提升运营能力，我们设计了这款人工智能软件，使其能够实时监测店铺内客流量，以按需增减人手，并通过熟客识别功能让商家为老顾客提供更加贴心和优惠的服务，增加新顾客对商店特色的了解，与顾客建立起良好关系。而对于那些对店铺的服务质量以及盈利有更高追求的商家，我们不仅提供会员管理功能，还设置了精准营销版块。将会员基本信息与其购买商品相对应构建用户画像后，本软件可以根据用户以往购买信息对其消费行为进行多维度分析，进而为其提供个性化服务，提升商家在行业内的竞争力，也使得用户有更加优质的购物体验。

![流程图](https://raw.githubusercontent.com/Jamesyu420/AI-Store/main/images/%E6%B5%81%E7%A8%8B%E5%9B%BE.png)

我们将功能的实现分为客流量监测、熟客识别、会员信息管理和精准营销几大功能模块，对程序的设计思路进行介绍。

### 客流监测

首先，因为客流统计数据在商店运营决策中发挥越来越重要的作用，所以商店需要对顾客群体进行宏观的了解。我们注意到，虽然一般的商店会在出入口处安装红外感应器进行通知和记录，但也存在例如无法识别障碍物阻挡、人的反复移动等问题。此外，商店需要的不仅仅是简单的客流量与成交率的数字记录，更包含店内实时客流量大小等数据，这样，商家才能够对不同时段店内工作人员的数量进行合理分配。因此，我们通过构建模型对人体进行检测来解决以上问题。

在构建模型的过程中，我们搜集了大量不同的行人数据集，考虑到华为的深度学习硬件设备HiLens可以在摄像的同时调用模型进行分析，为方便后期搭配使用，我们选择在华为云ModelArts平台上，通过自动与手动相结合的方法进行数据标注，并对标注错误的数据进行进一步更正，之后将其分成训练集和测试集，并使用YOLOv5算法进行模型训练。

![模型图](https://raw.githubusercontent.com/Jamesyu420/AI-Store/main/images/%E6%A8%A1%E5%9E%8B%E5%9B%BE.png)

之后我们将训练好的模型部署使用，构建高计算性能的API接口，由此，我们就可以对每一帧的视频进行截取，并通过调用深度学习模型构建来实时监测人像。之后，我们使用质心算法对检测到的人像进行追踪，并根据目标轨迹判断顾客进出商店的方向，以实现对商店人数的动态统计。除此之外，我们使用opencv库对视频的读取，标注与刷新功能，对传入的录像或实时监控场景进行人像标注和实时进出数据在视频中的动态显示，以便商家可以在视频中看到实时数据，并以文件的形式记录这些数据。

![演示图](https://raw.githubusercontent.com/Jamesyu420/AI-Store/main/images/%E8%B7%9F%E8%B8%AA%E5%9B%BE.png)

在对充分的视频进行了处理和解析后，我们选择Python的matplotlib库对记录下来的数据进行动态图表绘制，将店内人数的变化进行可视化的展示。这样的动态图表在统计学意义上是一个时间序列数据，因此我们选用ARIMA模型对异常值（峰值）进行探测并通知商家，此动态图也可以应用于对未来的趋势进行预测。这些都可以作为商家调整营业时间、确定日常和节假日以及疫情期间的工作人员数量分配的依据。商家也可以通过分析消费者重点关注或停留时间较长的区域，实现店铺规划、客群导流、货品陈列优化等，进而提升营业效率，让小摄像头发挥大作用。

为了给不具备联网条件的商家提供便利，我们还专门设计了导入视频的文件传入接口，以便商家将需要分析的监控视频交给机构（如乡镇服务站等），由他们代为统计分析，之后再将分析结果反馈给对应商家，以优化乡镇商店经营管理，提升用户体验感，进而推动乡镇经济发展。

此外，这一功能也可广泛应用于景点、车站、展区等人群密集处，以便根据实施客流量的变化及时采取措施，对客流进行控制。

### 熟客识别

为给新老用户提供更好的服务，提升其购物体验，我们开发了熟客识别功能，以便商家对光临的顾客形成初步认识，进而为其提供更贴心的服务。为实现这一功能，我们利用商家在收银台处设置的摄像头来即时识别并捕捉顾客面部特征。在这里，我们通过领先的C++开源库dlib中的深度学习模型，采用神经网络找到每个人脸的128个特征值，然后与顾客信息数据库中原有的顾客照片进行比对，以判别其为新顾客或老顾客。我们可以根据其光顾次数向商家随机迎客推荐方式，使得老顾客对店铺产生熟悉感与信任感、新顾客产生再次光临的欲望。

除此之外，为保证老顾客的回购率，我们可以与商家协商，建议其根据顾客光顾次数自动形成优惠力度，或根据我们未来对数据的分析结果将最合适的折扣程度推荐给商家，以提高顾客回购率，使商家获得更多盈利。除此之外，商家还可凭借顾客光顾次数达到某一数值建议其办理会员，从而使用会员管理、精准营销等版块为用户提供更有针对性的个性化服务。

### 会员信息管理与精准营销

我们除了商家为提供客流量监测，熟客识别等功能，还为其设置了会员管理与精准营销模块，在这一模块中，为了避免侵犯顾客个人隐私等问题，我们决定在顾客授权的前提下将其个人信息与购买商品的有关信息进行记录，从而提供更有针对性的服务。首先，我们可以选择性地询问顾客的基本信息（如生日，性别，年龄区间、家庭状况等），从而在将来实现生日当天自动发送祝福短信、加大优惠力度、提供赠品等服务，鼓励顾客在生日当天光顾店铺，购买喜欢的商品并享受优惠。对于非常重视顾客体验的店铺，我们也能够提供依据顾客日常购物偏好进行赠品种类推荐的功能，进而促进消费。而根据性别和年龄区间，我们可以向顾客推荐适合其所在年龄段人群的产品，让顾客得到更好的购物体验。

其次，我们根据在顾客消费过程中截取的数据与顾客头像，将顾客与其消费行为绑定，存入关系数据库中，进而为数据库中的每位顾客构建购物偏好画像，以便后续分析使用，实现会员的“一键办理”和“精准分析”。相比于传统商店繁琐的会员卡办理流程，这样的模式显得更加便捷，商家也可以通过贴心的会员办理方式直接或间接地提升顾客的回购率，来提高顾客对店铺的信赖度与忠诚度。

接下来，我们可以对消费者的喜好与需求进行判断，通过推荐算法为顾客提供再次光顾店铺时选购商品的推荐服务。此类功能的实现基于商品的协同推荐算法（简称ItemCF算法），依据顾客的历史行为给商家做推荐并解释。ItemCF算法通过计算物品相似度矩阵并每日更新，结合顾客的历史行为生成推荐购买商品列表。消费者将会享受到个性化的新品介绍，而这些新品正是与顾客以往所购商品相似的商品，能够反映消费者本人的历史购物偏好。这样不仅可以使店员工作更有针对性，还可以让顾客了解到自己以往购买同类商品的情况，并使得商家根据用户每次的选择实现对其消费习惯的进一步精准化记录，最终通过为顾客提供精准荐购服务而实现商店营业额的增长。

## 设计重点和难点

### 选择目标检测算法

通过了解目前流行并且常用的目标检测算法，我们从项目目的出发，对以下几种算法进行了具体的优劣分析：

<table>
   <tr>
      <td>算法</td>
      <td>优点</td>
      <td>缺点</td>
   </tr>
   <tr>
      <td>Faster R-CNN</td>
      <td>在R-CNN以及Fast R-CNN的基础上，一定程度上提高了速度，精度极高</td>
      <td>相对于其他算法而言速度仍然相对较慢</td>
   </tr>
   <tr>
      <td>YOLO</td>
      <td>速度快，能够轻松满足实时监测的速度要求，防止视频出现卡顿现象</td>
      <td>在精度方面，较Faster R-CNN低一些，对小目标、相互靠近物体的检测效果不占优势</td>
   </tr>
   <tr>
      <td>SSD</td>
      <td colspan="2">中和Faster R-CNN算法与YOLO算法的优势，在速度与精度方面都呈现中等效果</td>
   </tr>
</table>

考虑到项目主题为实时客流量监测，目的在于监测客流量的相对大小，而并非得到客流量的精确数值，因此我们经过分析比较选择了最新版本的YOLOv5算法，利用其速度快的优势，在监测过程中流畅地呈现出实时进出的顾客数量。

### 训练目标检测模型

由于目前关于目标检测的算法以及模型都是将识别出的目标物体进行分类，而我们的项目主题侧重于对人的识别，更加需要提高识别人像的精度，因此我们选择自己训练模型来提高适用性和准确度。首先，我们找到了符合实际客流监测场景的数据集。为了提高效率，我们利用华为ModelArts平台对数据集进行了标注，并结合YOLOv5算法训练出符合项目应用场景的模型，生成可实时调用的API，便于对实时录像进行标注。

### 计算累计客流量

1) 计数方式：对于已经确定的目标，我们采用在屏幕中央根据目标运动方向（水平/竖直）设置定位线的方式，对于经过定位线的目标进行累加计数。

2) 避免计数重复性：利用上述训练好的模型，可以对实时监测录像中每一帧的图片进行目标检测，但如果对每一帧中所有目标进行计数，则无法避免计数的重复性。因此利用质心算法对于已经检测出的目标进行实时追踪，并设置目标消失后的删除机制。而对于每次新检测出的目标也进行计数和追踪。

### GUI设计与监测结果的呈现

在UI方面，我们调查了较流行的用户界面设计工具，并对其进行了如下的分析对比。Tkinter：代码繁杂，美观性不足；Qt：美观性强，包含Qt Designer的交互式界面，可简化代码编写步骤。考虑到用户群体为商家、景区工作人员等，为了提升用户体验感，我们选择美观性与便捷性都相对较高的Python第三方库PyQt5来进行页面的开发与设计。

### 向用户展示监测结果

在设计过程中，我们发现PyQt5自带控件难以实现实时监测的目的，为解决这一问题，我们使用其与opencv库结合的方式实现摄像头的自动调用，并通过QLabel中图片的刷新效果呈现监测结果，以降低用户的操作难度，实现自动化监测。

### 可视化数据的呈现

为了使用户能够直观地看到商店的有关数据，我们选择matplotib库为用户呈现动态图表。然而在此过程中我们发现图表不仅在PyQt5的QLabel控件界面中得以呈现，还另外弹出了显示框。经过研究，我们发现这是由于matplotlib库中pause函数自动调用了show方法所致。为此，我们重新编写了pause函数，实现了可视化界面的嵌入。除此之外，我们选择在解析识别视频的同时将实时产生的数据传入图表，并每隔一秒截取图片对其进行刷新，从而直观地向用户呈现动态效果。

### 熟客识别的实现

为实现这一功能，首先，我们需要对视频中每一帧画面进行人脸识别，因此我们将图片灰度化，变换为HOG形式，之后提取图像的特征，从而利用方向梯度直方图(HOG)来获取人脸位置，之后利用Dilb中函数对人脸68个特征点进行定位，通过图像的几何变换，使各个特征点对齐，之后使用训练好的神经网络，将输入的脸部图像生成为128维的预测值，之后利用KNN分类器将新识别出的顾客面部与已有数据库中的数据进行比对，达到熟客识别目的。为了避免顾客识别的重复性，我们设置3小时之内不对同一个顾客进行再次计数。
